---
title: "Introduction to frcadastre"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to frcadastre}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  markdown: 
    wrap: 72
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# The package

## What are we talking about ?

The frcadastre package provides tools to download, prepare, and use
French cadastral datasets. It focuses on **PCI** and **Etalab** cadastre
dataset published on <https://cadastre.data.gouv.fr>.

## How to get it ?

```{r installation, eval = FALSE}
# From CRAN (once published)
install.packages("frcadastre")

# Development version from GitHub
devtools::install_github("mucau/frcadastre")
```

# Main features

## Etalab bundle

The `get_etalab()` function allows access to **PCI Etalab** processed
data by using bundle API from <https://cadastre.data.gouv.fr>. To know
the available layername data from **PCI Etalab** bundle, run
`get_etalab_layernames("proc")`. The `get_etalab()` function returns
`sf` objects.

The `get_etalab()` function works with an `id` argument (INSEE code) for
department or city, and the `data` layername you want to get.

```{r get_etalab, eval = FALSE}
library(frcadastre)
library(tmap)
ttm()

# Available dataset from Etalab bundle
get_etalab_layernames("proc")


# Download dataset from Etalab bundle
communes  <- get_etalab(id = "72", data = "communes") # Sarthe department for example
parcelles <- get_etalab(id = "72187", data = "parcelles") # 'Marigne-Laille' for example

tm_shape(communes) +
  tm_polygons(border.col = "red", alpha = 0.5) +
tm_shape(parcelles) +
  tm_polygons(col = "blue", alpha = 0.1)

```

## Etalab data

More datasets are available by donwloading data from this server:
<https://cadastre.data.gouv.fr/data/>.

The `get_etalab_data()` function allows access to **PCI Etalab** raw
data from the previous server. Datas are producted by date (millesime).

To know from **PCI Etalab** data server :

-   available millesimes, run `get_data_millesimes("etalab")` (for quick
    use, `"latest"` is better)

-   available data, run `get_etalab_layernames()`.

The `get_etalab()` asks an `commune` argument (INSEE code) for city, the
`data` layername you want to get, and the `millesime` required.

```{r get_etalab_data, eval = FALSE}
library(frcadastre)
library(tmap)
ttm()

# Available dataset from Etalab bundle
get_etalab_layernames("proc")


# Download dataset from Etalab data server
commune  <- get_etalab_data(commune = "72187", data = "commune") # 'Marigne-Laille' again
parcelle <- get_etalab_data(commune = "72187", data = "parcelle")
batiment <- get_etalab_data(commune = "72187", data = "batiment")
borne    <- get_etalab_data(commune = "72187", data = "borne")

tm_shape(commune) +
  tm_polygons(border.col = "red", fill_alpha = 0.5) +
tm_shape(parcelles) +
  tm_polygons(border.col = "blue", fill_alpha = 0.05) +
tm_shape(batiment) +
  tm_polygons(fill = "yellow") +
tm_shape(borne) +
  tm_dots(col = "blue", size = 0.5, fill_alpha = 1) 

```

## PCI data

Old raw datasets are also available from server. The `get_pci_data()`
function allows access to **PCI** raw data. Datas are also producted by
date (millesime) in `DXF` and `EDIGEO` format.

If you're motivated to juggle this data, good luck!

## IDU tools

Each parcel from France is referenced by an unique id (IDU).

The `frcadastre` package offers some tools to manage IDU:

-   `idu_check()` checks the IDU shape by using a pattern
-   `idu_build()` and `idu_split()` aggregate or split an IDU
-   `idu_detect_in_df()` and `idu_rename_in_df()` namange IDU in
    `data.frame` or `sf` object.

The most useful remains `idu_get_parcelle()` to get parcelle according
researched IDU.

```{r idu, eval = FALSE}
library(frcadastre)
library(tmap)
ttm()

# Check idu
true_idu <- "721870000A0001"
idu_check(true_idu) # return TRUE

false_idu <- "bazinga"
idu_check(false_idu) # return FALSE

# Split or build idu
split <- idu_split(true_idu)

build <- idu_build(split$code_dep,
                   split$code_com,
                   split$prefix,
                   split$section,
                   split$numero)

# Get parcel
my_parcel <- idu_get_parcelle(build)

qtm(my_parcel)

```

## Administrative boundaries

The `frcadastre` includes administrative boundaries from
<https://www.insee.fr/fr/information/2560452> : `commune_2025`,
`departement_2025`, and `region_2025`.

## Example workflow

```{r boundaries, eval = FALSE}
library(frcadastre)

# Load example dataset
data(commune_2025)

# Inspect
head(commune_2025)

```
